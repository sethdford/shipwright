name: Shipwright Patrol

# Scheduled patrol — runs checks against the repo and creates labeled issues
# for the pipeline to pick up automatically
run-name: "Shipwright Patrol — ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}"

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch: {} # Manual trigger for testing

permissions:
  contents: write # For state branch push
  issues: write # For creating patrol issues

jobs:
  patrol:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for doc staleness checks

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Shipwright
        run: |
          npm link

      - name: Restore persistent state
        run: |
          # Restore events/memory/costs from shipwright-data branch
          mkdir -p ~/.shipwright/memory

          if git fetch origin shipwright-data 2>/dev/null; then
            echo "Restoring state from shipwright-data branch..."
            for file in events.jsonl costs.json budget.json; do
              git show "origin/shipwright-data:${file}" > ~/.shipwright/"${file}" 2>/dev/null || true
            done
            # Restore memory directory
            for file in $(git ls-tree -r --name-only origin/shipwright-data -- memory/ 2>/dev/null); do
              mkdir -p ~/.shipwright/"$(dirname "$file")"
              git show "origin/shipwright-data:${file}" > ~/.shipwright/"${file}" 2>/dev/null || true
            done
            echo "State restored successfully"
          else
            echo "No shipwright-data branch found — first run, starting fresh"
            echo "[]" > ~/.shipwright/events.jsonl
            echo "{}" > ~/.shipwright/costs.json
            echo "{}" > ~/.shipwright/budget.json
          fi

      - name: Run patrol checks
        run: |
          echo "--- Running Shipwright Patrol ---"
          shipwright daemon patrol --once 2>&1 || {
            echo "WARNING: Patrol exited with code $? — continuing to persist state"
          }

      - name: Auto-label patrol findings
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add shipwright label to any open auto-patrol issues so daemon picks them up
          ISSUES=$(gh issue list --label "auto-patrol" --state open --json number --jq '.[].number' 2>/dev/null || echo "")
          if [ -n "$ISSUES" ]; then
            echo "$ISSUES" | while read -r num; do
              gh issue edit "$num" --repo "$GITHUB_REPOSITORY" --add-label "shipwright" 2>/dev/null || true
              echo "Labeled issue #$num with shipwright"
            done
          else
            echo "No open auto-patrol issues to label"
          fi

      - name: Persist state to shipwright-data branch
        if: always()
        run: |
          # Clone or create shipwright-data branch in a temp directory
          SW_STATE_DIR=$(mktemp -d)
          cd "$SW_STATE_DIR"
          git init
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # Try to pull existing branch
          if git fetch origin shipwright-data 2>/dev/null; then
            git checkout -b shipwright-data origin/shipwright-data
          else
            echo "Creating shipwright-data branch for the first time"
            git checkout --orphan shipwright-data
            echo "# Shipwright Persistent State" > README.md
            echo "" >> README.md
            echo "This branch stores events, costs, and memory across ephemeral CI runs." >> README.md
            echo "Do not merge this branch into main." >> README.md
          fi

          # Copy state files
          cp ~/.shipwright/events.jsonl . 2>/dev/null || true
          cp ~/.shipwright/costs.json . 2>/dev/null || true
          cp ~/.shipwright/budget.json . 2>/dev/null || true
          if [[ -d ~/.shipwright/memory ]]; then
            cp -r ~/.shipwright/memory . 2>/dev/null || true
          fi

          # Commit and push
          git config user.name "shipwright[bot]"
          git config user.email "shipwright[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet 2>/dev/null; then
            echo "No state changes to persist"
          else
            git commit -m "chore: persist patrol state [skip ci]"
            git push origin shipwright-data 2>/dev/null || {
              # Force push on conflict (last writer wins for state data)
              git push origin shipwright-data --force
            }
            echo "State persisted to shipwright-data branch"
          fi
