name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install tmux jq

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y tmux jq

      - name: Run pipeline tests
        run: bash scripts/cct-pipeline-test.sh

      - name: Run daemon tests
        run: bash scripts/cct-daemon-test.sh

      - name: Run prep tests
        run: bash scripts/cct-prep-test.sh

      - name: Run fleet tests
        run: bash scripts/cct-fleet-test.sh

      - name: Run fix tests
        run: bash scripts/cct-fix-test.sh

      - name: Run memory tests
        run: bash scripts/cct-memory-test.sh

      - name: Run session tests
        run: bash scripts/cct-session-test.sh

      - name: Run init tests
        run: bash scripts/cct-init-test.sh

      - name: Run tracker tests
        run: bash scripts/cct-tracker-test.sh

      - name: Run heartbeat tests
        run: bash scripts/cct-heartbeat-test.sh

      - name: Run remote tests
        run: bash scripts/cct-remote-test.sh

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint scripts
        run: |
          shellcheck -x scripts/cct scripts/cct-*.sh install.sh || true
