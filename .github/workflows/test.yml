name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Check version consistency
        run: bash scripts/check-version-consistency.sh

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install tmux jq

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y tmux jq

      - name: Run all test suites
        run: |
          # Auto-discover and run every test script listed in package.json "test"
          # This ensures CI always matches npm test — no more manual list drift.
          PASS=0
          FAIL=0
          FAILED_SUITES=""

          for test_script in scripts/sw-*-test.sh; do
            suite_name="$(basename "$test_script" .sh)"

            echo ""
            echo "═══════════════════════════════════════════════════════"
            echo "Running: $suite_name"
            echo "═══════════════════════════════════════════════════════"

            if bash "$test_script"; then
              PASS=$((PASS + 1))
              echo "✓ $suite_name passed"
            else
              FAIL=$((FAIL + 1))
              FAILED_SUITES="$FAILED_SUITES $suite_name"
              echo "✗ $suite_name FAILED"
            fi
          done

          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "CI Summary: $PASS passed, $FAIL failed ($(ls scripts/sw-*-test.sh | wc -l | tr -d ' ') total)"
          if [[ $FAIL -gt 0 ]]; then
            echo "Failed suites:$FAILED_SUITES"
            exit 1
          fi
          echo "All suites passed."

  # Budget-limited real-Claude smoke (~$0.25/PR); runs only when Claude secret is set
  integration-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - name: Check for Claude credentials
        run: |
          if [[ -z "$CLAUDE_CODE_OAUTH_TOKEN" && -z "$ANTHROPIC_API_KEY" ]]; then
            echo "No Claude credentials found — skipping integration test"
            echo "SKIP_CLAUDE=true" >> "$GITHUB_ENV"
          fi

      - uses: actions/checkout@v4
        if: env.SKIP_CLAUDE != 'true'

      - name: Install dependencies
        if: env.SKIP_CLAUDE != 'true'
        run: sudo apt-get update && sudo apt-get install -y tmux jq

      - name: Install Claude Code CLI
        if: env.SKIP_CLAUDE != 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Run budget-limited Claude integration smoke
        if: env.SKIP_CLAUDE != 'true'
        run: bash scripts/sw-integration-claude-test.sh

  # Validate integration-claude skip path when no secret (script must exit 0 and skip)
  integration-claude-skip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run integration-claude without secrets (expect skip)
        run: |
          out=$(bash scripts/sw-integration-claude-test.sh 2>&1) || exit 1
          echo "$out" | grep -q "Skipping integration-claude" || (echo "$out"; exit 1)
          echo "Skip path OK"

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint scripts
        run: |
          shellcheck -x -S warning scripts/sw scripts/sw-*.sh install.sh
