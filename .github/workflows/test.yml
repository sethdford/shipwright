name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install tmux jq

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y tmux jq

      - name: Run pipeline tests
        run: bash scripts/sw-pipeline-test.sh

      - name: Run daemon tests
        run: bash scripts/sw-daemon-test.sh

      - name: Run prep tests
        run: bash scripts/sw-prep-test.sh

      - name: Run fleet tests
        run: bash scripts/sw-fleet-test.sh

      - name: Run fix tests
        run: bash scripts/sw-fix-test.sh

      - name: Run memory tests
        run: bash scripts/sw-memory-test.sh

      - name: Run session tests
        run: bash scripts/sw-session-test.sh

      - name: Run init tests
        run: bash scripts/sw-init-test.sh

      - name: Run tracker tests
        run: bash scripts/sw-tracker-test.sh

      - name: Run heartbeat tests
        run: bash scripts/sw-heartbeat-test.sh

      - name: Run remote tests
        run: bash scripts/sw-remote-test.sh

      - name: Run intelligence tests
        run: bash scripts/sw-intelligence-test.sh

      - name: Run pipeline composer tests
        run: bash scripts/sw-pipeline-composer-test.sh

      - name: Run self-optimize tests
        run: bash scripts/sw-self-optimize-test.sh

      - name: Run predictive tests
        run: bash scripts/sw-predictive-test.sh

      - name: Run frontier tests
        run: bash scripts/sw-frontier-test.sh

      - name: Run connect tests
        run: bash scripts/sw-connect-test.sh

      - name: Run GitHub GraphQL tests
        run: bash scripts/sw-github-graphql-test.sh

      - name: Run GitHub Checks tests
        run: bash scripts/sw-github-checks-test.sh

      - name: Run GitHub Deploy tests
        run: bash scripts/sw-github-deploy-test.sh

      - name: Run docs tests
        run: bash scripts/sw-docs-test.sh

      - name: Run tmux tests
        run: bash scripts/sw-tmux-test.sh

      - name: Run status tests
        run: bash scripts/sw-status-test.sh

      - name: Run launchd tests
        run: bash scripts/sw-launchd-test.sh

      - name: Run recruit tests
        run: bash scripts/sw-recruit-test.sh

      - name: Run E2E smoke tests
        run: bash scripts/sw-e2e-smoke-test.sh

  # Budget-limited real-Claude smoke (~$0.25/PR); runs only when Claude secret is set
  integration-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' || secrets.ANTHROPIC_API_KEY != '' }}
    env:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y tmux jq

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run budget-limited Claude integration smoke
        run: bash scripts/sw-integration-claude-test.sh

  # Validate integration-claude skip path when no secret (script must exit 0 and skip)
  integration-claude-skip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run integration-claude without secrets (expect skip)
        run: |
          out=$(bash scripts/sw-integration-claude-test.sh 2>&1) || exit 1
          echo "$out" | grep -q "Skipping integration-claude" || (echo "$out"; exit 1)
          echo "Skip path OK"

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint scripts
        run: |
          shellcheck -x scripts/sw scripts/sw-*.sh install.sh || true
