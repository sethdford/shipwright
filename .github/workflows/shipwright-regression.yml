name: Shipwright Regression Detection

on:
  workflow_run:
    workflows: ["Shipwright Pipeline"]
    types: [completed]
  workflow_dispatch: {}

concurrency:
  group: shipwright-regression
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  regression:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure git
        run: |
          git config user.name "shipwright[bot]"
          git config user.email "shipwright[bot]@users.noreply.github.com"

      - name: Restore persistent state
        run: |
          mkdir -p ~/.shipwright/memory ~/.shipwright/baselines ~/.shipwright/optimization
          if git fetch origin shipwright-data 2>/dev/null; then
            echo "Restoring state from shipwright-data branch..."
            for file in events.jsonl costs.json budget.json; do
              git show "origin/shipwright-data:${file}" > ~/.shipwright/"${file}" 2>/dev/null || true
            done
            for dir in memory baselines optimization; do
              for file in $(git ls-tree -r --name-only origin/shipwright-data -- "${dir}/" 2>/dev/null); do
                mkdir -p ~/.shipwright/"$(dirname "$file")"
                git show "origin/shipwright-data:${file}" > ~/.shipwright/"${file}" 2>/dev/null || true
              done
            done
            echo "State restored successfully"
          else
            echo "No shipwright-data branch found — starting fresh"
          fi

      - name: Extract issue number from triggering run
        id: context
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger — running full regression check"
            echo "issue_number=" >> "$GITHUB_OUTPUT"
          else
            RUN_ID="${{ github.event.workflow_run.id }}"
            DISPLAY_TITLE=$(gh run view "$RUN_ID" --json displayTitle --jq '.displayTitle' 2>/dev/null || echo "")
            ISSUE_NUMBER=$(echo "$DISPLAY_TITLE" | grep -oE '#[0-9]+' | head -1 | tr -d '#' || true)
            echo "Triggering run: $RUN_ID — issue #${ISSUE_NUMBER:-?}"
            echo "issue_number=${ISSUE_NUMBER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run regression check
        id: check
        run: |
          set +e
          REGRESSION_OUTPUT=$(bash ./scripts/sw-regression.sh check --json 2>/dev/null || echo "{}")
          HAS_REGRESSION=$(echo "$REGRESSION_OUTPUT" | jq -r '.has_regression // false' 2>/dev/null || echo "false")
          echo "has_regression=${HAS_REGRESSION}" >> "$GITHUB_OUTPUT"
          echo "Regression detected: ${HAS_REGRESSION}"
          echo "$REGRESSION_OUTPUT" | jq . 2>/dev/null || true

      - name: Create issue for regression
        if: steps.check.outputs.has_regression == 'true'
        run: |
          set +e
          ISSUE_NUMBER="${{ steps.context.outputs.issue_number }}"
          REPORT=$(bash ./scripts/sw-regression.sh report --markdown 2>/dev/null || echo "No details available")
          gh issue create \
            --title "Regression detected after pipeline #${ISSUE_NUMBER:-?}" \
            --label "auto-patrol" --label "regression" \
            --body "$(cat <<EOF
          ## Regression Detected

          ${REPORT}

          Triggered by pipeline run for issue #${ISSUE_NUMBER:-unknown}.
          EOF
          )" || echo "WARNING: Failed to create regression issue"

      - name: Update baseline
        run: |
          bash ./scripts/sw-regression.sh baseline 2>/dev/null || true

      - name: Persist state to shipwright-data branch
        if: always()
        run: |
          SW_STATE_DIR=$(mktemp -d)
          cd "$SW_STATE_DIR"
          git init
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          if git fetch origin shipwright-data 2>/dev/null; then
            git checkout -b shipwright-data origin/shipwright-data
          else
            git checkout --orphan shipwright-data
            echo "# Shipwright Persistent State" > README.md
          fi
          cp ~/.shipwright/events.jsonl . 2>/dev/null || true
          cp ~/.shipwright/costs.json . 2>/dev/null || true
          cp ~/.shipwright/budget.json . 2>/dev/null || true
          for dir in memory baselines optimization; do
            if [[ -d ~/.shipwright/${dir} ]]; then
              cp -r ~/.shipwright/${dir} . 2>/dev/null || true
            fi
          done
          git config user.name "shipwright[bot]"
          git config user.email "shipwright[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet 2>/dev/null; then
            echo "No state changes to persist"
          else
            git commit -m "chore: persist regression state [skip ci]"
            PUSHED=false
            for ATTEMPT in 1 2 3 4 5; do
              if git push origin shipwright-data 2>/dev/null; then
                PUSHED=true
                break
              fi
              JITTER=$((RANDOM % 10 + 2))
              echo "Push attempt $ATTEMPT failed — retrying in ${JITTER}s..."
              sleep "$JITTER"
              git fetch origin shipwright-data 2>/dev/null || true
              git rebase origin/shipwright-data 2>/dev/null || {
                echo "Rebase conflict — force pushing"
                git rebase --abort 2>/dev/null || true
                git push origin shipwright-data --force 2>/dev/null && PUSHED=true && break
              }
            done
            if [ "$PUSHED" = "true" ]; then
              echo "State persisted to shipwright-data branch"
            else
              echo "WARNING: Failed to persist state after 5 attempts — non-fatal"
            fi
          fi
