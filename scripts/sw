#!/usr/bin/env bash
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  Shipwright CLI (sw)                                                   ║
# ║  Orchestrate autonomous Claude Code agent teams in tmux                 ║
# ╚═══════════════════════════════════════════════════════════════════════════╝
set -euo pipefail

VERSION="2.2.0"

# Resolve symlinks (required for npm global install where bin/ symlinks to node_modules/)
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

# ─── Colors (matches Seth's tmux theme) ─────────────────────────────────────
CYAN='\033[38;2;0;212;255m'     # #00d4ff — primary accent
PURPLE='\033[38;2;124;58;237m'  # #7c3aed — secondary
BLUE='\033[38;2;0;102;255m'     # #0066ff — tertiary
GREEN='\033[38;2;74;222;128m'   # success
YELLOW='\033[38;2;250;204;21m'  # warning
RED='\033[38;2;248;113;113m'    # error
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

# ─── Cross-platform compatibility ──────────────────────────────────────────
# shellcheck source=lib/compat.sh
[[ -f "$SCRIPT_DIR/lib/compat.sh" ]] && source "$SCRIPT_DIR/lib/compat.sh"
# ─── Helpers ─────────────────────────────────────────────────────────────────

info()    { echo -e "${CYAN}${BOLD}▸${RESET} $*"; }
success() { echo -e "${GREEN}${BOLD}✓${RESET} $*"; }
warn()    { echo -e "${YELLOW}${BOLD}⚠${RESET} $*"; }
error()   { echo -e "${RED}${BOLD}✗${RESET} $*" >&2; }

check_tmux() {
    if ! command -v tmux &>/dev/null; then
        error "tmux is not installed. Install it first:"
        echo -e "  ${DIM}brew install tmux${RESET}  (macOS)"
        echo -e "  ${DIM}sudo apt install tmux${RESET}  (Ubuntu/Debian)"
        exit 1
    fi
}

check_in_tmux() {
    if [[ -z "${TMUX:-}" ]]; then
        warn "Not inside a tmux session."
        echo -e "  Start one with: ${DIM}tmux new -s work${RESET}"
        echo -e "  Or attach:      ${DIM}tmux attach${RESET}"
        exit 1
    fi
}

ensure_repo_setup() {
    if [[ ! -d ".claude" ]]; then
        error "This repo hasn't been set up for Shipwright."
        echo ""
        echo -e "  ${CYAN}${BOLD}Run one of:${RESET}"
        echo -e "    ${DIM}shipwright setup${RESET}  — guided setup (recommended)"
        echo -e "    ${DIM}shipwright init${RESET}   — quick setup (no prompts)"
        echo ""
        exit 1
    fi
}

show_version() {
    echo -e "${CYAN}${BOLD}shipwright${RESET} ${DIM}v${VERSION}${RESET} — Orchestrate AI Coding Teams  ${DIM}(aliases: sw, cct)${RESET}"
}

show_help() {
    show_version
    echo ""
    echo -e "${BOLD}USAGE${RESET}"
    echo -e "  ${CYAN}shipwright${RESET} <command> [options]    ${DIM}(also: sw, cct)${RESET}"
    echo -e "  ${CYAN}shipwright${RESET} <group> <subcommand> [options]"
    echo ""
    echo -e "${BOLD}COMMAND GROUPS${RESET}  ${DIM}(new grouped syntax)${RESET}"
    echo -e "  ${CYAN}agent${RESET} <subcmd>         ${DIM}Agent management: recruit, swarm, standup, guild, oversight${RESET}"
    echo -e "  ${CYAN}quality${RESET} <subcmd>       ${DIM}Quality & review: code-review, security-audit, testgen, hygiene${RESET}"
    echo -e "  ${CYAN}observe${RESET} <subcmd>       ${DIM}Observability: vitals, dora, retro, stream, activity, replay${RESET}"
    echo -e "  ${CYAN}release${RESET} <subcmd>       ${DIM}Release & deploy: release, release-manager, changelog, deploy${RESET}"
    echo -e "  ${CYAN}intel${RESET} <subcmd>         ${DIM}Intelligence: predict, intelligence, strategic, optimize${RESET}"
    echo ""
    echo -e "${BOLD}CORE COMMANDS${RESET}  ${DIM}(flat aliases for backwards compat)${RESET}"
    echo -e "  ${CYAN}session${RESET} [name]       Create a new tmux window for a Claude team"
    echo -e "  ${CYAN}status${RESET} [--json]        Show dashboard of running teams and agents"
    echo -e "  ${CYAN}mission-control|mc${RESET}   Terminal-based pipeline mission control (drill-down, team tree, orchestration)"
    echo -e "  ${CYAN}ps${RESET}                    Show running agent processes and status"
    echo -e "  ${CYAN}logs${RESET} [team] [opts]    View and search agent pane logs"
    echo -e "  ${CYAN}activity${RESET} [cmd] [opts]  Live agent activity stream — watch Claude think"
    echo -e "  ${CYAN}templates${RESET} [list|show]  Manage team composition templates"
    echo -e "  ${CYAN}doctor${RESET}                Validate your setup and check for issues"
    echo -e "  ${CYAN}cleanup${RESET} [--force]     Clean up orphaned team sessions"
    echo -e "  ${CYAN}reaper${RESET} [--watch]       Automatic pane cleanup when agents exit"
    echo -e "  ${CYAN}upgrade${RESET} [--apply]     Check for updates from the repo (dry-run by default)"
    echo -e "  ${CYAN}loop${RESET} \"goal\" [opts]    ${BOLD}Continuous agent loop${RESET} — run until goal is achieved"
    echo -e "  ${CYAN}pipeline${RESET} <cmd>         ${BOLD}Full delivery pipeline${RESET} — idea to production"
    echo -e "  ${CYAN}worktree${RESET} <cmd>         Manage git worktrees for agent isolation"
    echo -e "  ${CYAN}prep${RESET} [options]         ${BOLD}Repo preparation${RESET} — generate .claude/ configs for agents"
    echo -e "  ${CYAN}hygiene${RESET} <cmd>         ${BOLD}Repo hygiene${RESET} — dead code, structure, deps, cleanup"
    echo -e "  ${CYAN}daemon${RESET} <cmd>           ${BOLD}Issue watcher${RESET} — auto-process GitHub issues"
    echo -e "  ${CYAN}autonomous|auto${RESET} <cmd>  ${BOLD}Autonomous loop${RESET} — AI-building-AI: analyze, create, build, learn"
    echo -e "  ${CYAN}memory${RESET} <cmd>           ${BOLD}Persistent memory${RESET} — learn from every pipeline run"
    echo -e "  ${CYAN}guild${RESET} <cmd>            ${BOLD}Knowledge guilds${RESET} — cross-team learning, shared patterns"
    echo -e "  ${CYAN}instrument${RESET} <cmd>       ${BOLD}Pipeline instrumentation${RESET} — record predicted vs actual metrics"
    echo -e "  ${CYAN}cost${RESET} <cmd>             ${BOLD}Cost intelligence${RESET} — track tokens, budgets, model routing"
    echo -e "  ${CYAN}adaptive${RESET} <cmd>         ${BOLD}Adaptive tuning${RESET} — data-driven pipeline defaults from historical runs"
    echo -e "  ${CYAN}regression${RESET} <cmd>       ${BOLD}Regression detection${RESET} — detect regressions after merge"
    echo -e "  ${CYAN}incident${RESET} <cmd>        ${BOLD}Incident commander${RESET} — detect failures, triage, remediate"
    echo -e "  ${CYAN}db${RESET} <cmd>               ${BOLD}SQLite persistence${RESET} — events, runs, developers, metrics"
    echo -e "  ${CYAN}deps${RESET} <cmd>            ${BOLD}Dependency updates${RESET} — scan, classify, test, merge Dependabot/Renovate PRs"
    echo -e "  ${CYAN}fleet${RESET} <cmd>           ${BOLD}Multi-repo fleet${RESET} — orchestrate daemons across repos"
    echo -e "  ${CYAN}fleet-viz${RESET} <cmd>        ${BOLD}Fleet visualization${RESET} — cross-repo insights and queue"
    echo -e "  ${CYAN}fix${RESET} \"goal\" [opts]     ${BOLD}Bulk fix${RESET} — apply a fix across multiple repos"
    echo -e "  ${CYAN}dashboard${RESET} <cmd>        ${BOLD}Fleet Command${RESET} — real-time WebSocket dashboard"
    echo -e "  ${CYAN}public-dashboard${RESET} <cmd> ${BOLD}Public dashboard${RESET} — shareable pipeline progress (static HTML)"
    echo -e "  ${CYAN}share${RESET} [...]            ${BOLD}Share pipeline${RESET} — alias for ${DIM}public-dashboard share${RESET}"
    echo -e "  ${CYAN}jira${RESET} <cmd>             ${BOLD}Jira sync${RESET} — bidirectional issue sync with Jira"
    echo -e "  ${CYAN}linear${RESET} <cmd>           ${BOLD}Linear sync${RESET} — bidirectional issue sync with Linear"
    echo -e "  ${CYAN}model${RESET} <cmd>            ${BOLD}Model router${RESET} — intelligent model routing and cost optimization"
    echo -e "  ${CYAN}tracker${RESET} <cmd>           ${BOLD}Issue tracker${RESET} — configure Linear/Jira integration"
    echo -e "  ${CYAN}heartbeat${RESET} <cmd>        ${BOLD}Agent heartbeat${RESET} — write/check/list/clear heartbeats"
    echo -e "  ${CYAN}standup${RESET} <cmd>         ${BOLD}Daily standups${RESET} — gather status, summarize work, report blockers"
    echo -e "  ${CYAN}checkpoint${RESET} <cmd>       ${BOLD}Checkpoints${RESET} — save/restore agent state mid-stage"
    echo -e "  ${CYAN}durable${RESET} <cmd>          ${BOLD}Durable workflow${RESET} — event log, checkpoints, locks, exactly-once"
    echo -e "  ${CYAN}webhook${RESET} <cmd>          ${BOLD}GitHub webhooks${RESET} — instant issue processing, no polling"
    echo -e "  ${CYAN}decompose${RESET} <cmd>        ${BOLD}Issue decomposer${RESET} — analyze complexity, auto-create subtasks"
    echo -e "  ${CYAN}discovery${RESET} <cmd>        ${BOLD}Cross-pipeline learning${RESET} — real-time knowledge sharing"
    echo -e "  ${CYAN}connect${RESET} <cmd>          ${BOLD}Team connect${RESET} — sync local state to team dashboard"
    echo -e "  ${CYAN}remote${RESET} <cmd>           ${BOLD}Remote machines${RESET} — register and manage distributed workers"
    echo -e "  ${CYAN}launchd${RESET} <cmd>          ${BOLD}Process supervision${RESET} — auto-start daemon + dashboard on boot"
    echo -e "  ${CYAN}auth${RESET} <cmd>            ${BOLD}GitHub authentication${RESET} — OAuth login, token management, multi-user"
    echo -e "  ${CYAN}docs${RESET} <cmd>            ${BOLD}Documentation keeper${RESET} — auto-sync docs from source"
    echo -e "  ${CYAN}changelog${RESET} <cmd>       ${BOLD}Changelog engine${RESET} — auto-generate release notes and migration guides"
    echo -e "  ${CYAN}docs-agent${RESET} <cmd>      ${BOLD}Autonomous docs agent${RESET} — scan gaps, sync, coverage, API ref"
    echo -e "  ${CYAN}doc-fleet${RESET} <cmd>       ${BOLD}Documentation fleet${RESET} — 5 specialized agents: audit, refactor, enhance docs"
    echo -e "  ${CYAN}release${RESET} <cmd>         ${BOLD}Release automation${RESET} — bump versions, changelog, tags, releases"
    echo -e "  ${CYAN}release-manager|rm${RESET}    ${BOLD}Autonomous release pipeline${RESET} — readiness checks, RC flow, rollback"
    echo -e "  ${CYAN}replay${RESET} <cmd>           ${BOLD}Pipeline DVR${RESET} — list, show, narrative, diff, export, compare runs"
    echo -e "  ${CYAN}scale${RESET} <cmd>            ${BOLD}Dynamic team scaling${RESET} — scale agents up/down during pipeline"
    echo -e "  ${CYAN}swarm${RESET} <cmd>            ${BOLD}Agent swarm manager${RESET} — registry, spawning, scaling, health, topology"
    echo -e "  ${CYAN}dora${RESET} <cmd>            ${BOLD}DORA metrics${RESET} — deploy frequency, lead time, CFR, MTTR dashboard"
    echo -e "  ${CYAN}retro${RESET} <cmd>           ${BOLD}Sprint retrospective${RESET} — analyze sprints, identify improvements, create actions"
    echo -e "  ${CYAN}tmux${RESET} <cmd>            ${BOLD}tmux health${RESET} — doctor, install plugins, fix issues"
    echo -e "  ${CYAN}vitals${RESET}               ${BOLD}Pipeline vitals${RESET} — real-time health scoring and dashboard"
    echo -e "  ${CYAN}stream${RESET}               ${BOLD}Terminal streaming${RESET} — live agent output to dashboard or CLI"
    echo -e "  ${CYAN}github${RESET}               ${BOLD}GitHub context${RESET} — repo metadata, security, blame"
    echo -e "  ${CYAN}checks${RESET}               ${BOLD}GitHub checks${RESET} — CI check runs and status"
    echo -e "  ${CYAN}ci${RESET}                   ${BOLD}CI/CD orchestration${RESET} — workflow generation, matrix, caching, secrets"
    echo -e "  ${CYAN}deploys${RESET}              ${BOLD}Deployments${RESET} — deployment history and environments"
    echo -e "  ${CYAN}github-app${RESET}           ${BOLD}GitHub App management${RESET} — JWT, tokens, webhooks, manifest"
    echo -e "  ${CYAN}pr${RESET}                   ${BOLD}PR lifecycle${RESET} — auto-review, merge, cleanup, feedback"
    echo -e "  ${CYAN}context${RESET}              ${BOLD}Context engine${RESET} — gather context for pipeline stages"
    echo -e "  ${CYAN}trace${RESET}                ${BOLD}E2E traceability${RESET} — issue to commit to PR to deploy"
    echo -e "  ${CYAN}widgets${RESET}              ${BOLD}Status widgets${RESET} — embeddable badges, Slack messages, markdown"
    echo -e "  ${CYAN}eventbus${RESET}             ${BOLD}Event bus${RESET} — real-time inter-component communication"
    echo -e "  ${CYAN}otel${RESET}                 ${BOLD}OpenTelemetry observability${RESET} — Prometheus metrics, traces, OTLP export"
    echo -e "  ${CYAN}triage${RESET}                ${BOLD}Issue labeling & prioritization${RESET} — auto-analyze, label, score, team sizing"
    echo -e "  ${CYAN}quality${RESET}               ${BOLD}Quality validation${RESET} — ruthless gates, adversarial audits, completion detection"
    echo -e "  ${CYAN}oversight${RESET}             ${BOLD}Quality oversight board${RESET} — multi-agent review council, voting, architecture governance"
    echo -e "  ${CYAN}code-review${RESET}           ${BOLD}Autonomous code review${RESET} — clean code, SOLID, architecture boundaries, complexity"
    echo -e "  ${CYAN}pm${RESET}                    ${BOLD}Autonomous PM agent${RESET} — intelligent team sizing, composition, orchestration"
    echo -e "  ${CYAN}strategic${RESET}             ${BOLD}Strategic intelligence${RESET} — analyze strategy, metrics, create improvement issues"
    echo -e "  ${CYAN}team-stages${RESET}          ${BOLD}Multi-agent stage execution${RESET} — compose teams, delegate tasks, tally votes"
    echo -e "  ${CYAN}ux${RESET}                    ${BOLD}Premium UX layer${RESET} — themes, animations, shortcuts, accessibility"
    echo -e "  ${CYAN}recruit${RESET}               ${BOLD}Agent recruitment${RESET} — skill matching, role definitions, performance evaluation"
    echo -e "  ${CYAN}testgen${RESET}              ${BOLD}Test generation${RESET} — analyze coverage, generate tests, maintain thresholds"
    echo -e "  ${CYAN}security-audit|audit${RESET} ${BOLD}Security auditing${RESET} — secrets, licenses, vulnerabilities, SBOM, compliance"
    echo -e "  ${CYAN}init${RESET}                  ${BOLD}Quick tmux setup${RESET} — one command, no prompts"
    echo -e "  ${CYAN}setup${RESET}                 ${BOLD}Guided setup${RESET} — prerequisites, init, doctor, quick start"
    echo -e "  ${CYAN}help${RESET}                  Show this help message"
    echo -e "  ${CYAN}version${RESET}               Show version"
    echo -e "  ${CYAN}hello${RESET}                Say hello world"
    echo ""
    echo -e "${BOLD}CONTINUOUS LOOP${RESET}  ${DIM}(autonomous agent operation)${RESET}"
    echo -e "  ${DIM}shipwright loop \"Build auth\" --test-cmd \"npm test\"${RESET}"
    echo -e "  ${DIM}shipwright loop \"Fix bugs\" --max-iterations 10 --model sonnet${RESET}"
    echo -e "  ${DIM}shipwright loop \"Build API\" --agents 3 --skip-permissions${RESET}"
    echo -e "  ${DIM}shipwright loop --resume${RESET}                   # Resume interrupted loop"
    echo ""
    echo -e "${BOLD}DELIVERY PIPELINE${RESET}  ${DIM}(idea to production)${RESET}"
    echo -e "  ${DIM}shipwright pipeline start --goal \"Add auth\" --pipeline standard${RESET}"
    echo -e "  ${DIM}shipwright pipeline start --issue 123 --skip-gates${RESET}"
    echo -e "  ${DIM}shipwright pipeline resume${RESET}               # Resume from last stage"
    echo -e "  ${DIM}shipwright pipeline status${RESET}                # Show progress dashboard"
    echo ""
    echo -e "${BOLD}AUTONOMOUS DAEMON${RESET}  ${DIM}(watch GitHub, auto-deliver)${RESET}"
    echo -e "  ${DIM}shipwright daemon start${RESET}                  # Start issue watcher (foreground)"
    echo -e "  ${DIM}shipwright daemon start --detach${RESET}         # Start in background tmux session"
    echo -e "  ${DIM}shipwright daemon status${RESET}                 # Show active pipelines and queue"
    echo -e "  ${DIM}shipwright daemon metrics${RESET}                # DORA/DX metrics dashboard"
    echo -e "  ${DIM}shipwright daemon stop${RESET}                   # Graceful shutdown"
    echo ""
    echo -e "${BOLD}MEMORY & COST${RESET}  ${DIM}(intelligence layer)${RESET}"
    echo -e "  ${DIM}shipwright memory show${RESET}                    # Show learned patterns for this repo"
    echo -e "  ${DIM}shipwright memory search \"auth\"${RESET}            # Search across all memories"
    echo -e "  ${DIM}shipwright memory stats${RESET}                    # Memory usage and coverage"
    echo -e "  ${DIM}shipwright cost show${RESET}                        # Token usage and spend overview"
    echo -e "  ${DIM}shipwright cost budget set 10.00${RESET}           # Set daily budget"
    echo -e "  ${DIM}shipwright cost show --period 30 --by-stage${RESET} # Detailed cost report"
    echo ""
    echo -e "${BOLD}FLEET OPERATIONS${RESET}  ${DIM}(multi-repo management)${RESET}"
    echo -e "  ${DIM}shipwright fleet start${RESET}                      # Start daemons for all configured repos"
    echo -e "  ${DIM}shipwright fleet status${RESET}                     # Show fleet-wide status"
    echo -e "  ${DIM}shipwright fleet metrics${RESET}                    # Cross-repo DORA metrics"
    echo -e "  ${DIM}shipwright fix \"Bump deps\" --repos ~/api,~/web${RESET}  # Bulk fix"
    echo ""
    echo -e "${BOLD}REPO PREPARATION${RESET}  ${DIM}(prep repo for agents)${RESET}"
    echo -e "  ${DIM}shipwright prep${RESET}                          # Analyze repo, generate .claude/ configs"
    echo -e "  ${DIM}shipwright prep --check${RESET}                  # Audit existing prep quality"
    echo -e "  ${DIM}shipwright prep --with-claude${RESET}            # Deep analysis using Claude Code"
    echo ""
    echo -e "${BOLD}GITHUB INTEGRATION${RESET}  ${DIM}(repo context, checks, deployments)${RESET}"
    echo -e "  ${DIM}shipwright github context${RESET}              # Show repo GitHub context"
    echo -e "  ${DIM}shipwright github security${RESET}             # Show security alerts"
    echo -e "  ${DIM}shipwright github blame <path>${RESET}         # Show file ownership"
    echo -e "  ${DIM}shipwright checks list${RESET}                 # Show check runs"
    echo -e "  ${DIM}shipwright deploys list${RESET}                # Show deployment history"
    echo ""
    echo -e "${BOLD}TEST SUITES${RESET}  ${DIM}(validate shipwright components)${RESET}"
    echo -e "  ${DIM}shipwright daemon test${RESET}                   # Run daemon test suite"
    echo -e "  ${DIM}shipwright prep test${RESET}                     # Run prep test suite"
    echo -e "  ${DIM}shipwright pipeline test${RESET}                 # Run pipeline test suite"
    echo -e "  ${DIM}shipwright e2e${RESET} <cmd>          ${BOLD}Test orchestration${RESET} — smoke/integration/regression"
    echo ""
    echo -e "${BOLD}AUDIT & QUALITY${RESET}  ${DIM}(loop guardrails)${RESET}"
    echo -e "  ${DIM}shipwright loop \"goal\" --audit${RESET}                     # Self-reflection each iteration"
    echo -e "  ${DIM}shipwright loop \"goal\" --audit-agent${RESET}               # Separate auditor reviews work"
    echo -e "  ${DIM}shipwright loop \"goal\" --quality-gates${RESET}             # Automated quality checks"
    echo -e "  ${DIM}shipwright loop \"goal\" --definition-of-done dod.md${RESET} # Custom completion checklist"
    echo ""
    echo -e "${BOLD}TMUX KEYBINDINGS${RESET}  ${DIM}(with the bundled tmux.conf)${RESET}"
    echo -e "  ${PURPLE}prefix + T${RESET}           Launch a team session  (runs ${DIM}shipwright session${RESET})"
    echo -e "  ${PURPLE}prefix + Ctrl-t${RESET}      Show team dashboard    (runs ${DIM}shipwright status${RESET})"
    echo ""
    echo -e "${BOLD}EXAMPLES${RESET}"
    echo -e "  ${DIM}shipwright session refactor${RESET}      # New window named 'claude-refactor'"
    echo -e "  ${DIM}shipwright session${RESET}               # New window with timestamp name"
    echo -e "  ${DIM}shipwright status${RESET}                # See all active teams"
    echo -e "  ${DIM}shipwright ps${RESET}                    # Show agent processes"
    echo -e "  ${DIM}shipwright logs myteam${RESET}           # View logs for a team"
    echo -e "  ${DIM}shipwright logs myteam --follow${RESET}  # Tail agent logs"
    echo -e "  ${DIM}shipwright doctor${RESET}                # Check setup health"
    echo -e "  ${DIM}shipwright cleanup${RESET}               # Dry-run: show what would be cleaned"
    echo -e "  ${DIM}shipwright cleanup --force${RESET}       # Actually kill orphaned sessions"
    echo -e "  ${DIM}shipwright upgrade${RESET}               # Check what's changed since install"
    echo -e "  ${DIM}shipwright upgrade --apply${RESET}       # Apply available updates"
    echo ""
    echo -e "${DIM}Docs: https://sethdford.github.io/shipwright  |  GitHub: https://github.com/sethdford/shipwright${RESET}"
}

# ─── Command Group Routers ───────────────────────────────────────────────────

route_agent() {
    local subcmd="${1:-help}"
    shift 2>/dev/null || true
    case "$subcmd" in
        recruit)      exec "$SCRIPT_DIR/sw-recruit.sh" "$@" ;;
        swarm)        exec "$SCRIPT_DIR/sw-swarm.sh" "$@" ;;
        standup)      exec "$SCRIPT_DIR/sw-standup.sh" "$@" ;;
        guild)        exec "$SCRIPT_DIR/sw-guild.sh" "$@" ;;
        oversight)    exec "$SCRIPT_DIR/sw-oversight.sh" "$@" ;;
        help|*) echo "Usage: shipwright agent {recruit|swarm|standup|guild|oversight}"; exit 1 ;;
    esac
}

route_quality() {
    local subcmd="${1:-help}"
    shift 2>/dev/null || true
    case "$subcmd" in
        code-review)      exec "$SCRIPT_DIR/sw-code-review.sh" "$@" ;;
        security-audit|audit) exec "$SCRIPT_DIR/sw-security-audit.sh" "$@" ;;
        testgen)          exec "$SCRIPT_DIR/sw-testgen.sh" "$@" ;;
        hygiene)          exec "$SCRIPT_DIR/sw-hygiene.sh" "$@" ;;
        help|*) echo "Usage: shipwright quality {code-review|security-audit|testgen|hygiene}"; exit 1 ;;
    esac
}

route_observe() {
    local subcmd="${1:-help}"
    shift 2>/dev/null || true
    case "$subcmd" in
        vitals)       exec "$SCRIPT_DIR/sw-pipeline-vitals.sh" "$@" ;;
        dora)         exec "$SCRIPT_DIR/sw-dora.sh" "$@" ;;
        retro)        exec "$SCRIPT_DIR/sw-retro.sh" "$@" ;;
        stream)       exec "$SCRIPT_DIR/sw-stream.sh" "$@" ;;
        activity)     exec "$SCRIPT_DIR/sw-activity.sh" "$@" ;;
        replay)       exec "$SCRIPT_DIR/sw-replay.sh" "$@" ;;
        status)       exec "$SCRIPT_DIR/sw-status.sh" "$@" ;;
        help|*) echo "Usage: shipwright observe {vitals|dora|retro|stream|activity|replay|status}"; exit 1 ;;
    esac
}

route_release() {
    local subcmd="${1:-help}"
    shift 2>/dev/null || true
    case "$subcmd" in
        release)          exec "$SCRIPT_DIR/sw-release.sh" "$@" ;;
        release-manager)  exec "$SCRIPT_DIR/sw-release-manager.sh" "$@" ;;
        changelog)        exec "$SCRIPT_DIR/sw-changelog.sh" "$@" ;;
        deploy|deploys)   exec "$SCRIPT_DIR/sw-github-deploy.sh" "$@" ;;
        help|*) echo "Usage: shipwright release {release|release-manager|changelog|deploy}"; exit 1 ;;
    esac
}

route_intel() {
    local subcmd="${1:-help}"
    shift 2>/dev/null || true
    case "$subcmd" in
        predict)      exec "$SCRIPT_DIR/sw-predictive.sh" "$@" ;;
        intelligence) exec "$SCRIPT_DIR/sw-intelligence.sh" "$@" ;;
        strategic)    exec "$SCRIPT_DIR/sw-strategic.sh" "$@" ;;
        optimize)     exec "$SCRIPT_DIR/sw-self-optimize.sh" "$@" ;;
        help|*) echo "Usage: shipwright intel {predict|intelligence|strategic|optimize}"; exit 1 ;;
    esac
}

# ─── Welcome message helper ──────────────────────────────────────────────────
show_welcome() {
    echo ""
    echo -e "${CYAN}${BOLD}  Welcome to Shipwright v${VERSION}!${RESET}"
    echo -e "${DIM}  ════════════════════════════════════════════${RESET}"
    echo ""
    echo -e "  It looks like this repo hasn't been set up yet."
    echo ""
    echo -e "  ${CYAN}${BOLD}→${RESET} For guided setup (4 phases):    ${DIM}shipwright setup${RESET}"
    echo -e "  ${CYAN}${BOLD}→${RESET} For quick setup (no prompts):     ${DIM}shipwright init${RESET}"
    echo -e "  ${CYAN}${BOLD}→${RESET} For full help:                   ${DIM}shipwright help${RESET}"
    echo ""
}

# ─── Command Router ──────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"

    # Special case: if no arguments and .claude/ doesn't exist, show welcome
    if [[ "$#" -eq 0 && ! -d ".claude" && ! -d "$(pwd)/.claude" ]]; then
        show_welcome
        return 0
    fi

    shift 2>/dev/null || true

    case "$cmd" in
        # Command groups
        agent)          route_agent "$@" ;;
        quality)        route_quality "$@" ;;
        observe)        route_observe "$@" ;;
        release)        route_release "$@" ;;
        intel)          route_intel "$@" ;;

        session)
            check_tmux
            check_in_tmux
            exec "$SCRIPT_DIR/sw-session.sh" "$@"
            ;;
        status)
            check_tmux
            exec "$SCRIPT_DIR/sw-status.sh" "$@"
            ;;
        mission-control|mc)
            exec "$SCRIPT_DIR/sw-mission-control.sh" "$@"
            ;;
        ps)
            check_tmux
            exec "$SCRIPT_DIR/sw-ps.sh" "$@"
            ;;
        logs)
            exec "$SCRIPT_DIR/sw-logs.sh" "$@"
            ;;
        activity)
            exec "$SCRIPT_DIR/sw-activity.sh" "$@"
            ;;
        templates)
            exec "$SCRIPT_DIR/sw-templates.sh" "$@"
            ;;
        doctor)
            exec "$SCRIPT_DIR/sw-doctor.sh" "$@"
            ;;
        cleanup)
            check_tmux
            exec "$SCRIPT_DIR/sw-cleanup.sh" "$@"
            ;;
        reaper)
            check_tmux
            exec "$SCRIPT_DIR/sw-reaper.sh" "$@"
            ;;
        upgrade)
            exec "$SCRIPT_DIR/sw-upgrade.sh" "$@"
            ;;
        loop)
            exec "$SCRIPT_DIR/sw-loop.sh" "$@"
            ;;
        pipeline)
            exec "$SCRIPT_DIR/sw-pipeline.sh" "$@"
            ;;
        worktree)
            exec "$SCRIPT_DIR/sw-worktree.sh" "$@"
            ;;
        prep)
            exec "$SCRIPT_DIR/sw-prep.sh" "$@"
            ;;
        hygiene)
            exec "$SCRIPT_DIR/sw-hygiene.sh" "$@"
            ;;
        daemon)
            exec "$SCRIPT_DIR/sw-daemon.sh" "$@"
            ;;
        autonomous|auto)
            exec "$SCRIPT_DIR/sw-autonomous.sh" "$@"
            ;;
        memory)
            exec "$SCRIPT_DIR/sw-memory.sh" "$@"
            ;;
        guild)
            exec "$SCRIPT_DIR/sw-guild.sh" "$@"
            ;;
        instrument)
            exec "$SCRIPT_DIR/sw-instrument.sh" "$@"
            ;;
        cost)
            exec "$SCRIPT_DIR/sw-cost.sh" "$@"
            ;;
        adaptive)
            exec "$SCRIPT_DIR/sw-adaptive.sh" "$@"
            ;;
        regression)
            exec "$SCRIPT_DIR/sw-regression.sh" "$@"
            ;;
        incident)
            exec "$SCRIPT_DIR/sw-incident.sh" "$@"
            ;;
        db)
            exec "$SCRIPT_DIR/sw-db.sh" "$@"
            ;;
        deps)
            exec "$SCRIPT_DIR/sw-deps.sh" "$@"
            ;;
        fleet)
            exec "$SCRIPT_DIR/sw-fleet.sh" "$@"
            ;;
        fleet-viz)
            exec "$SCRIPT_DIR/sw-fleet-viz.sh" "$@"
            ;;
        fix)
            exec "$SCRIPT_DIR/sw-fix.sh" "$@"
            ;;
        init)
            exec "$SCRIPT_DIR/sw-init.sh" "$@"
            ;;
        setup)
            exec "$SCRIPT_DIR/sw-setup.sh" "$@"
            ;;
        dashboard|dash)
            exec "$SCRIPT_DIR/sw-dashboard.sh" "$@"
            ;;
        public-dashboard|share)
            exec "$SCRIPT_DIR/sw-public-dashboard.sh" "$@"
            ;;
        jira)
            exec "$SCRIPT_DIR/sw-jira.sh" "$@"
            ;;
        linear)
            exec "$SCRIPT_DIR/sw-linear.sh" "$@"
            ;;
        model)
            exec "$SCRIPT_DIR/sw-model-router.sh" "$@"
            ;;
        tracker)
            exec "$SCRIPT_DIR/sw-tracker.sh" "$@"
            ;;
        heartbeat)
            exec "$SCRIPT_DIR/sw-heartbeat.sh" "$@"
            ;;
        standup)
            exec "$SCRIPT_DIR/sw-standup.sh" "$@"
            ;;
        checkpoint)
            exec "$SCRIPT_DIR/sw-checkpoint.sh" "$@"
            ;;
        durable)
            exec "$SCRIPT_DIR/sw-durable.sh" "$@"
            ;;
        webhook)
            exec "$SCRIPT_DIR/sw-webhook.sh" "$@"
            ;;
        connect)
            exec "$SCRIPT_DIR/sw-connect.sh" "$@"
            ;;
        remote)
            exec "$SCRIPT_DIR/sw-remote.sh" "$@"
            ;;
        launchd)
            exec "$SCRIPT_DIR/sw-launchd.sh" "$@"
            ;;
        auth)
            exec "$SCRIPT_DIR/sw-auth.sh" "$@"
            ;;
        intelligence|intel)
            exec "$SCRIPT_DIR/sw-intelligence.sh" "$@"
            ;;
        optimize)
            exec "$SCRIPT_DIR/sw-self-optimize.sh" "$@"
            ;;
        predict)
            exec "$SCRIPT_DIR/sw-predictive.sh" "$@"
            ;;
        adversarial)
            exec "$SCRIPT_DIR/sw-adversarial.sh" "$@"
            ;;
        simulation)
            exec "$SCRIPT_DIR/sw-developer-simulation.sh" "$@"
            ;;
        strategic|strategy)
            exec "$SCRIPT_DIR/sw-strategic.sh" "$@"
            ;;
        architecture)
            exec "$SCRIPT_DIR/sw-architecture-enforcer.sh" "$@"
            ;;
        vitals)
            exec "$SCRIPT_DIR/sw-pipeline-vitals.sh" "$@"
            ;;
        stream)
            exec "$SCRIPT_DIR/sw-stream.sh" "$@"
            ;;
        docs)
            exec "$SCRIPT_DIR/sw-docs.sh" "$@"
            ;;
        changelog)
            exec "$SCRIPT_DIR/sw-changelog.sh" "$@"
            ;;
        docs-agent)
            exec "$SCRIPT_DIR/sw-docs-agent.sh" "$@"
            ;;
        doc-fleet)
            exec "$SCRIPT_DIR/sw-doc-fleet.sh" "$@"
            ;;
        release)
            exec "$SCRIPT_DIR/sw-release.sh" "$@"
            ;;
        release-manager|rm)
            exec "$SCRIPT_DIR/sw-release-manager.sh" "$@"
            ;;
        replay)
            exec "$SCRIPT_DIR/sw-replay.sh" "$@"
            ;;
        scale)
            exec "$SCRIPT_DIR/sw-scale.sh" "$@"
            ;;
        swarm)
            exec "$SCRIPT_DIR/sw-swarm.sh" "$@"
            ;;
        dora)
            exec "$SCRIPT_DIR/sw-dora.sh" "$@"
            ;;
        retro)
            exec "$SCRIPT_DIR/sw-retro.sh" "$@"
            ;;
        tmux)
            exec "$SCRIPT_DIR/sw-tmux.sh" "$@"
            ;;
        tmux-pipeline)
            exec "$SCRIPT_DIR/sw-tmux-pipeline.sh" "$@"
            ;;
        github|gh-context)
            exec "$SCRIPT_DIR/sw-github-graphql.sh" "$@"
            ;;
        checks)
            exec "$SCRIPT_DIR/sw-github-checks.sh" "$@"
            ;;
        ci)
            exec "$SCRIPT_DIR/sw-ci.sh" "$@"
            ;;
        deploys|deployments)
            exec "$SCRIPT_DIR/sw-github-deploy.sh" "$@"
            ;;
        github-app)
            exec "$SCRIPT_DIR/sw-github-app.sh" "$@"
            ;;
        decompose)
            exec "$SCRIPT_DIR/sw-decompose.sh" "$@"
            ;;
        discovery)
            exec "$SCRIPT_DIR/sw-discovery.sh" "$@"
            ;;
        context)
            exec "$SCRIPT_DIR/sw-context.sh" "$@"
            ;;
        trace)
            exec "$SCRIPT_DIR/sw-trace.sh" "$@"
            ;;
        pr)
            exec "$SCRIPT_DIR/sw-pr-lifecycle.sh" "$@"
            ;;
        widgets)
            exec "$SCRIPT_DIR/sw-widgets.sh" "$@"
            ;;
        feedback)
            exec "$SCRIPT_DIR/sw-feedback.sh" "$@"
            ;;
        eventbus)
            exec "$SCRIPT_DIR/sw-eventbus.sh" "$@"
            ;;
        otel)
            exec "$SCRIPT_DIR/sw-otel.sh" "$@"
            ;;
        triage)
            exec "$SCRIPT_DIR/sw-triage.sh" "$@"
            ;;
        quality)
            exec "$SCRIPT_DIR/sw-quality.sh" "$@"
            ;;
        oversight)
            exec "$SCRIPT_DIR/sw-oversight.sh" "$@"
            ;;
        code-review)
            exec "$SCRIPT_DIR/sw-code-review.sh" "$@"
            ;;
        pm)
            exec "$SCRIPT_DIR/sw-pm.sh" "$@"
            ;;
        team-stages)
            exec "$SCRIPT_DIR/sw-team-stages.sh" "$@"
            ;;
        ux)
            exec "$SCRIPT_DIR/sw-ux.sh" "$@"
            ;;
        recruit)
            exec "$SCRIPT_DIR/sw-recruit.sh" "$@"
            ;;
        testgen)
            exec "$SCRIPT_DIR/sw-testgen.sh" "$@"
            ;;
        e2e)
            exec "$SCRIPT_DIR/sw-e2e-orchestrator.sh" "$@"
            ;;
        security-audit|audit)
            exec "$SCRIPT_DIR/sw-security-audit.sh" "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            show_version
            ;;
        hello)
            echo "hello world"
            ;;
        *)
            error "Unknown command: ${cmd}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
