#!/usr/bin/env bash
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  Shipwright CLI (cct)                                                   ║
# ║  Orchestrate autonomous Claude Code agent teams in tmux                 ║
# ╚═══════════════════════════════════════════════════════════════════════════╝
set -euo pipefail

VERSION="1.5.1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ─── Colors (matches Seth's tmux theme) ─────────────────────────────────────
CYAN='\033[38;2;0;212;255m'     # #00d4ff — primary accent
PURPLE='\033[38;2;124;58;237m'  # #7c3aed — secondary
BLUE='\033[38;2;0;102;255m'     # #0066ff — tertiary
GREEN='\033[38;2;74;222;128m'   # success
YELLOW='\033[38;2;250;204;21m'  # warning
RED='\033[38;2;248;113;113m'    # error
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

# ─── Helpers ─────────────────────────────────────────────────────────────────

info()    { echo -e "${CYAN}${BOLD}▸${RESET} $*"; }
success() { echo -e "${GREEN}${BOLD}✓${RESET} $*"; }
warn()    { echo -e "${YELLOW}${BOLD}⚠${RESET} $*"; }
error()   { echo -e "${RED}${BOLD}✗${RESET} $*" >&2; }

check_tmux() {
    if ! command -v tmux &>/dev/null; then
        error "tmux is not installed. Install it first:"
        echo -e "  ${DIM}brew install tmux${RESET}  (macOS)"
        echo -e "  ${DIM}sudo apt install tmux${RESET}  (Ubuntu/Debian)"
        exit 1
    fi
}

check_in_tmux() {
    if [[ -z "${TMUX:-}" ]]; then
        warn "Not inside a tmux session."
        echo -e "  Start one with: ${DIM}tmux new -s work${RESET}"
        echo -e "  Or attach:      ${DIM}tmux attach${RESET}"
        exit 1
    fi
}

show_version() {
    echo -e "${CYAN}${BOLD}shipwright${RESET} ${DIM}v${VERSION}${RESET} — Orchestrate AI Coding Teams  ${DIM}(aliases: sw, cct)${RESET}"
}

show_help() {
    show_version
    echo ""
    echo -e "${BOLD}USAGE${RESET}"
    echo -e "  ${CYAN}shipwright${RESET} <command> [options]    ${DIM}(also: sw, cct)${RESET}"
    echo ""
    echo -e "${BOLD}COMMANDS${RESET}"
    echo -e "  ${CYAN}session${RESET} [name]       Create a new tmux window for a Claude team"
    echo -e "  ${CYAN}status${RESET}               Show dashboard of running teams and agents"
    echo -e "  ${CYAN}ps${RESET}                    Show running agent processes and status"
    echo -e "  ${CYAN}logs${RESET} [team] [opts]    View and search agent pane logs"
    echo -e "  ${CYAN}templates${RESET} [list|show]  Manage team composition templates"
    echo -e "  ${CYAN}doctor${RESET}                Validate your setup and check for issues"
    echo -e "  ${CYAN}cleanup${RESET} [--force]     Clean up orphaned team sessions"
    echo -e "  ${CYAN}reaper${RESET} [--watch]       Automatic pane cleanup when agents exit"
    echo -e "  ${CYAN}upgrade${RESET} [--apply]     Check for updates from the repo (dry-run by default)"
    echo -e "  ${CYAN}loop${RESET} \"goal\" [opts]    ${BOLD}Continuous agent loop${RESET} — run until goal is achieved"
    echo -e "  ${CYAN}pipeline${RESET} <cmd>         ${BOLD}Full delivery pipeline${RESET} — idea to production"
    echo -e "  ${CYAN}worktree${RESET} <cmd>         Manage git worktrees for agent isolation"
    echo -e "  ${CYAN}prep${RESET} [options]         ${BOLD}Repo preparation${RESET} — generate .claude/ configs for agents"
    echo -e "  ${CYAN}daemon${RESET} <cmd>           ${BOLD}Issue watcher${RESET} — auto-process GitHub issues"
    echo -e "  ${CYAN}memory${RESET} <cmd>           ${BOLD}Persistent memory${RESET} — learn from every pipeline run"
    echo -e "  ${CYAN}cost${RESET} <cmd>             ${BOLD}Cost intelligence${RESET} — track tokens, budgets, model routing"
    echo -e "  ${CYAN}init${RESET}                  ${BOLD}Quick tmux setup${RESET} — one command, no prompts"
    echo -e "  ${CYAN}help${RESET}                  Show this help message"
    echo -e "  ${CYAN}version${RESET}               Show version"
    echo ""
    echo -e "${BOLD}CONTINUOUS LOOP${RESET}  ${DIM}(autonomous agent operation)${RESET}"
    echo -e "  ${DIM}cct loop \"Build auth\" --test-cmd \"npm test\"${RESET}"
    echo -e "  ${DIM}cct loop \"Fix bugs\" --max-iterations 10 --model sonnet${RESET}"
    echo -e "  ${DIM}cct loop \"Build API\" --agents 3 --skip-permissions${RESET}"
    echo -e "  ${DIM}cct loop --resume${RESET}                   # Resume interrupted loop"
    echo ""
    echo -e "${BOLD}DELIVERY PIPELINE${RESET}  ${DIM}(idea to production)${RESET}"
    echo -e "  ${DIM}cct pipeline start --goal \"Add auth\" --pipeline standard${RESET}"
    echo -e "  ${DIM}cct pipeline start --issue 123 --skip-gates${RESET}"
    echo -e "  ${DIM}cct pipeline resume${RESET}               # Resume from last stage"
    echo -e "  ${DIM}cct pipeline status${RESET}                # Show progress dashboard"
    echo ""
    echo -e "${BOLD}AUTONOMOUS DAEMON${RESET}  ${DIM}(watch GitHub, auto-deliver)${RESET}"
    echo -e "  ${DIM}cct daemon start${RESET}                  # Start issue watcher (foreground)"
    echo -e "  ${DIM}cct daemon start --detach${RESET}         # Start in background tmux session"
    echo -e "  ${DIM}cct daemon status${RESET}                 # Show active pipelines and queue"
    echo -e "  ${DIM}cct daemon metrics${RESET}                # DORA/DX metrics dashboard"
    echo -e "  ${DIM}cct daemon stop${RESET}                   # Graceful shutdown"
    echo ""
    echo -e "${BOLD}MEMORY & COST${RESET}  ${DIM}(intelligence layer)${RESET}"
    echo -e "  ${DIM}cct memory show${RESET}                    # Show learned patterns for this repo"
    echo -e "  ${DIM}cct memory search \"auth\"${RESET}            # Search across all memories"
    echo -e "  ${DIM}cct memory stats${RESET}                    # Memory usage and coverage"
    echo -e "  ${DIM}cct cost show${RESET}                        # Token usage and spend overview"
    echo -e "  ${DIM}cct cost budget set 10.00${RESET}           # Set daily budget"
    echo -e "  ${DIM}cct cost show --period 30 --by-stage${RESET} # Detailed cost report"
    echo ""
    echo -e "${BOLD}REPO PREPARATION${RESET}  ${DIM}(prep repo for agents)${RESET}"
    echo -e "  ${DIM}cct prep${RESET}                          # Analyze repo, generate .claude/ configs"
    echo -e "  ${DIM}cct prep --check${RESET}                  # Audit existing prep quality"
    echo -e "  ${DIM}cct prep --with-claude${RESET}            # Deep analysis using Claude Code"
    echo ""
    echo -e "${BOLD}TEST SUITES${RESET}  ${DIM}(validate cct components)${RESET}"
    echo -e "  ${DIM}cct daemon test${RESET}                   # Run daemon test suite"
    echo -e "  ${DIM}cct prep test${RESET}                     # Run prep test suite"
    echo -e "  ${DIM}cct pipeline test${RESET}                 # Run pipeline test suite"
    echo ""
    echo -e "${BOLD}AUDIT & QUALITY${RESET}  ${DIM}(loop guardrails)${RESET}"
    echo -e "  ${DIM}cct loop \"goal\" --audit${RESET}                     # Self-reflection each iteration"
    echo -e "  ${DIM}cct loop \"goal\" --audit-agent${RESET}               # Separate auditor reviews work"
    echo -e "  ${DIM}cct loop \"goal\" --quality-gates${RESET}             # Automated quality checks"
    echo -e "  ${DIM}cct loop \"goal\" --definition-of-done dod.md${RESET} # Custom completion checklist"
    echo ""
    echo -e "${BOLD}TMUX KEYBINDINGS${RESET}  ${DIM}(with the bundled tmux.conf)${RESET}"
    echo -e "  ${PURPLE}prefix + T${RESET}           Launch a team session  (runs ${DIM}cct session${RESET})"
    echo -e "  ${PURPLE}prefix + Ctrl-t${RESET}      Show team dashboard    (runs ${DIM}cct status${RESET})"
    echo ""
    echo -e "${BOLD}EXAMPLES${RESET}"
    echo -e "  ${DIM}cct session refactor${RESET}      # New window named 'claude-refactor'"
    echo -e "  ${DIM}cct session${RESET}               # New window with timestamp name"
    echo -e "  ${DIM}cct status${RESET}                # See all active teams"
    echo -e "  ${DIM}cct ps${RESET}                    # Show agent processes"
    echo -e "  ${DIM}cct logs myteam${RESET}           # View logs for a team"
    echo -e "  ${DIM}cct logs myteam --follow${RESET}  # Tail agent logs"
    echo -e "  ${DIM}cct doctor${RESET}                # Check setup health"
    echo -e "  ${DIM}cct cleanup${RESET}               # Dry-run: show what would be cleaned"
    echo -e "  ${DIM}cct cleanup --force${RESET}       # Actually kill orphaned sessions"
    echo -e "  ${DIM}cct upgrade${RESET}               # Check what's changed since install"
    echo -e "  ${DIM}cct upgrade --apply${RESET}       # Apply available updates"
    echo ""
    echo -e "${DIM}Docs: https://sethdford.github.io/shipwright  |  GitHub: https://github.com/sethdford/shipwright${RESET}"
}

# ─── Command Router ──────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        session)
            check_tmux
            check_in_tmux
            exec "$SCRIPT_DIR/cct-session.sh" "$@"
            ;;
        status)
            check_tmux
            exec "$SCRIPT_DIR/cct-status.sh" "$@"
            ;;
        ps)
            check_tmux
            exec "$SCRIPT_DIR/cct-ps.sh" "$@"
            ;;
        logs)
            exec "$SCRIPT_DIR/cct-logs.sh" "$@"
            ;;
        templates)
            exec "$SCRIPT_DIR/cct-templates.sh" "$@"
            ;;
        doctor)
            exec "$SCRIPT_DIR/cct-doctor.sh" "$@"
            ;;
        cleanup)
            check_tmux
            exec "$SCRIPT_DIR/cct-cleanup.sh" "$@"
            ;;
        reaper)
            check_tmux
            exec "$SCRIPT_DIR/cct-reaper.sh" "$@"
            ;;
        upgrade)
            exec "$SCRIPT_DIR/cct-upgrade.sh" "$@"
            ;;
        loop)
            exec "$SCRIPT_DIR/cct-loop.sh" "$@"
            ;;
        pipeline)
            exec "$SCRIPT_DIR/cct-pipeline.sh" "$@"
            ;;
        worktree)
            exec "$SCRIPT_DIR/cct-worktree.sh" "$@"
            ;;
        prep)
            exec "$SCRIPT_DIR/cct-prep.sh" "$@"
            ;;
        daemon)
            exec "$SCRIPT_DIR/cct-daemon.sh" "$@"
            ;;
        memory)
            exec "$SCRIPT_DIR/cct-memory.sh" "$@"
            ;;
        cost)
            exec "$SCRIPT_DIR/cct-cost.sh" "$@"
            ;;
        init)
            exec "$SCRIPT_DIR/cct-init.sh" "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            show_version
            ;;
        *)
            error "Unknown command: ${cmd}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
