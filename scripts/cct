#!/usr/bin/env bash
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  Shipwright CLI (cct)                                                   ║
# ║  Orchestrate autonomous Claude Code agent teams in tmux                 ║
# ╚═══════════════════════════════════════════════════════════════════════════╝
set -euo pipefail

VERSION="1.7.1"

# Resolve symlinks (required for npm global install where bin/ symlinks to node_modules/)
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

# ─── Colors (matches Seth's tmux theme) ─────────────────────────────────────
CYAN='\033[38;2;0;212;255m'     # #00d4ff — primary accent
PURPLE='\033[38;2;124;58;237m'  # #7c3aed — secondary
BLUE='\033[38;2;0;102;255m'     # #0066ff — tertiary
GREEN='\033[38;2;74;222;128m'   # success
YELLOW='\033[38;2;250;204;21m'  # warning
RED='\033[38;2;248;113;113m'    # error
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

# ─── Cross-platform compatibility ──────────────────────────────────────────
# shellcheck source=lib/compat.sh
[[ -f "$SCRIPT_DIR/lib/compat.sh" ]] && source "$SCRIPT_DIR/lib/compat.sh"
# ─── Helpers ─────────────────────────────────────────────────────────────────

info()    { echo -e "${CYAN}${BOLD}▸${RESET} $*"; }
success() { echo -e "${GREEN}${BOLD}✓${RESET} $*"; }
warn()    { echo -e "${YELLOW}${BOLD}⚠${RESET} $*"; }
error()   { echo -e "${RED}${BOLD}✗${RESET} $*" >&2; }

check_tmux() {
    if ! command -v tmux &>/dev/null; then
        error "tmux is not installed. Install it first:"
        echo -e "  ${DIM}brew install tmux${RESET}  (macOS)"
        echo -e "  ${DIM}sudo apt install tmux${RESET}  (Ubuntu/Debian)"
        exit 1
    fi
}

check_in_tmux() {
    if [[ -z "${TMUX:-}" ]]; then
        warn "Not inside a tmux session."
        echo -e "  Start one with: ${DIM}tmux new -s work${RESET}"
        echo -e "  Or attach:      ${DIM}tmux attach${RESET}"
        exit 1
    fi
}

show_version() {
    echo -e "${CYAN}${BOLD}shipwright${RESET} ${DIM}v${VERSION}${RESET} — Orchestrate AI Coding Teams  ${DIM}(aliases: sw, cct)${RESET}"
}

show_help() {
    show_version
    echo ""
    echo -e "${BOLD}USAGE${RESET}"
    echo -e "  ${CYAN}shipwright${RESET} <command> [options]    ${DIM}(also: sw, cct)${RESET}"
    echo ""
    echo -e "${BOLD}COMMANDS${RESET}"
    echo -e "  ${CYAN}session${RESET} [name]       Create a new tmux window for a Claude team"
    echo -e "  ${CYAN}status${RESET}               Show dashboard of running teams and agents"
    echo -e "  ${CYAN}ps${RESET}                    Show running agent processes and status"
    echo -e "  ${CYAN}logs${RESET} [team] [opts]    View and search agent pane logs"
    echo -e "  ${CYAN}templates${RESET} [list|show]  Manage team composition templates"
    echo -e "  ${CYAN}doctor${RESET}                Validate your setup and check for issues"
    echo -e "  ${CYAN}cleanup${RESET} [--force]     Clean up orphaned team sessions"
    echo -e "  ${CYAN}reaper${RESET} [--watch]       Automatic pane cleanup when agents exit"
    echo -e "  ${CYAN}upgrade${RESET} [--apply]     Check for updates from the repo (dry-run by default)"
    echo -e "  ${CYAN}loop${RESET} \"goal\" [opts]    ${BOLD}Continuous agent loop${RESET} — run until goal is achieved"
    echo -e "  ${CYAN}pipeline${RESET} <cmd>         ${BOLD}Full delivery pipeline${RESET} — idea to production"
    echo -e "  ${CYAN}worktree${RESET} <cmd>         Manage git worktrees for agent isolation"
    echo -e "  ${CYAN}prep${RESET} [options]         ${BOLD}Repo preparation${RESET} — generate .claude/ configs for agents"
    echo -e "  ${CYAN}daemon${RESET} <cmd>           ${BOLD}Issue watcher${RESET} — auto-process GitHub issues"
    echo -e "  ${CYAN}memory${RESET} <cmd>           ${BOLD}Persistent memory${RESET} — learn from every pipeline run"
    echo -e "  ${CYAN}cost${RESET} <cmd>             ${BOLD}Cost intelligence${RESET} — track tokens, budgets, model routing"
    echo -e "  ${CYAN}fleet${RESET} <cmd>           ${BOLD}Multi-repo fleet${RESET} — orchestrate daemons across repos"
    echo -e "  ${CYAN}fix${RESET} \"goal\" [opts]     ${BOLD}Bulk fix${RESET} — apply a fix across multiple repos"
    echo -e "  ${CYAN}dashboard${RESET} <cmd>        ${BOLD}Fleet Command${RESET} — real-time WebSocket dashboard"
    echo -e "  ${CYAN}jira${RESET} <cmd>             ${BOLD}Jira sync${RESET} — bidirectional issue sync with Jira"
    echo -e "  ${CYAN}linear${RESET} <cmd>           ${BOLD}Linear sync${RESET} — bidirectional issue sync with Linear"
    echo -e "  ${CYAN}tracker${RESET} <cmd>           ${BOLD}Issue tracker${RESET} — configure Linear/Jira integration"
    echo -e "  ${CYAN}heartbeat${RESET} <cmd>        ${BOLD}Agent heartbeat${RESET} — write/check/list/clear heartbeats"
    echo -e "  ${CYAN}checkpoint${RESET} <cmd>       ${BOLD}Checkpoints${RESET} — save/restore agent state mid-stage"
    echo -e "  ${CYAN}remote${RESET} <cmd>           ${BOLD}Remote machines${RESET} — register and manage distributed workers"
    echo -e "  ${CYAN}init${RESET}                  ${BOLD}Quick tmux setup${RESET} — one command, no prompts"
    echo -e "  ${CYAN}setup${RESET}                 ${BOLD}Guided setup${RESET} — prerequisites, init, doctor, quick start"
    echo -e "  ${CYAN}help${RESET}                  Show this help message"
    echo -e "  ${CYAN}version${RESET}               Show version"
    echo ""
    echo -e "${BOLD}CONTINUOUS LOOP${RESET}  ${DIM}(autonomous agent operation)${RESET}"
    echo -e "  ${DIM}shipwright loop \"Build auth\" --test-cmd \"npm test\"${RESET}"
    echo -e "  ${DIM}shipwright loop \"Fix bugs\" --max-iterations 10 --model sonnet${RESET}"
    echo -e "  ${DIM}shipwright loop \"Build API\" --agents 3 --skip-permissions${RESET}"
    echo -e "  ${DIM}shipwright loop --resume${RESET}                   # Resume interrupted loop"
    echo ""
    echo -e "${BOLD}DELIVERY PIPELINE${RESET}  ${DIM}(idea to production)${RESET}"
    echo -e "  ${DIM}shipwright pipeline start --goal \"Add auth\" --pipeline standard${RESET}"
    echo -e "  ${DIM}shipwright pipeline start --issue 123 --skip-gates${RESET}"
    echo -e "  ${DIM}shipwright pipeline resume${RESET}               # Resume from last stage"
    echo -e "  ${DIM}shipwright pipeline status${RESET}                # Show progress dashboard"
    echo ""
    echo -e "${BOLD}AUTONOMOUS DAEMON${RESET}  ${DIM}(watch GitHub, auto-deliver)${RESET}"
    echo -e "  ${DIM}shipwright daemon start${RESET}                  # Start issue watcher (foreground)"
    echo -e "  ${DIM}shipwright daemon start --detach${RESET}         # Start in background tmux session"
    echo -e "  ${DIM}shipwright daemon status${RESET}                 # Show active pipelines and queue"
    echo -e "  ${DIM}shipwright daemon metrics${RESET}                # DORA/DX metrics dashboard"
    echo -e "  ${DIM}shipwright daemon stop${RESET}                   # Graceful shutdown"
    echo ""
    echo -e "${BOLD}MEMORY & COST${RESET}  ${DIM}(intelligence layer)${RESET}"
    echo -e "  ${DIM}shipwright memory show${RESET}                    # Show learned patterns for this repo"
    echo -e "  ${DIM}shipwright memory search \"auth\"${RESET}            # Search across all memories"
    echo -e "  ${DIM}shipwright memory stats${RESET}                    # Memory usage and coverage"
    echo -e "  ${DIM}shipwright cost show${RESET}                        # Token usage and spend overview"
    echo -e "  ${DIM}shipwright cost budget set 10.00${RESET}           # Set daily budget"
    echo -e "  ${DIM}shipwright cost show --period 30 --by-stage${RESET} # Detailed cost report"
    echo ""
    echo -e "${BOLD}FLEET OPERATIONS${RESET}  ${DIM}(multi-repo management)${RESET}"
    echo -e "  ${DIM}shipwright fleet start${RESET}                      # Start daemons for all configured repos"
    echo -e "  ${DIM}shipwright fleet status${RESET}                     # Show fleet-wide status"
    echo -e "  ${DIM}shipwright fleet metrics${RESET}                    # Cross-repo DORA metrics"
    echo -e "  ${DIM}shipwright fix \"Bump deps\" --repos ~/api,~/web${RESET}  # Bulk fix"
    echo ""
    echo -e "${BOLD}REPO PREPARATION${RESET}  ${DIM}(prep repo for agents)${RESET}"
    echo -e "  ${DIM}shipwright prep${RESET}                          # Analyze repo, generate .claude/ configs"
    echo -e "  ${DIM}shipwright prep --check${RESET}                  # Audit existing prep quality"
    echo -e "  ${DIM}shipwright prep --with-claude${RESET}            # Deep analysis using Claude Code"
    echo ""
    echo -e "${BOLD}TEST SUITES${RESET}  ${DIM}(validate shipwright components)${RESET}"
    echo -e "  ${DIM}shipwright daemon test${RESET}                   # Run daemon test suite"
    echo -e "  ${DIM}shipwright prep test${RESET}                     # Run prep test suite"
    echo -e "  ${DIM}shipwright pipeline test${RESET}                 # Run pipeline test suite"
    echo ""
    echo -e "${BOLD}AUDIT & QUALITY${RESET}  ${DIM}(loop guardrails)${RESET}"
    echo -e "  ${DIM}shipwright loop \"goal\" --audit${RESET}                     # Self-reflection each iteration"
    echo -e "  ${DIM}shipwright loop \"goal\" --audit-agent${RESET}               # Separate auditor reviews work"
    echo -e "  ${DIM}shipwright loop \"goal\" --quality-gates${RESET}             # Automated quality checks"
    echo -e "  ${DIM}shipwright loop \"goal\" --definition-of-done dod.md${RESET} # Custom completion checklist"
    echo ""
    echo -e "${BOLD}TMUX KEYBINDINGS${RESET}  ${DIM}(with the bundled tmux.conf)${RESET}"
    echo -e "  ${PURPLE}prefix + T${RESET}           Launch a team session  (runs ${DIM}shipwright session${RESET})"
    echo -e "  ${PURPLE}prefix + Ctrl-t${RESET}      Show team dashboard    (runs ${DIM}shipwright status${RESET})"
    echo ""
    echo -e "${BOLD}EXAMPLES${RESET}"
    echo -e "  ${DIM}shipwright session refactor${RESET}      # New window named 'claude-refactor'"
    echo -e "  ${DIM}shipwright session${RESET}               # New window with timestamp name"
    echo -e "  ${DIM}shipwright status${RESET}                # See all active teams"
    echo -e "  ${DIM}shipwright ps${RESET}                    # Show agent processes"
    echo -e "  ${DIM}shipwright logs myteam${RESET}           # View logs for a team"
    echo -e "  ${DIM}shipwright logs myteam --follow${RESET}  # Tail agent logs"
    echo -e "  ${DIM}shipwright doctor${RESET}                # Check setup health"
    echo -e "  ${DIM}shipwright cleanup${RESET}               # Dry-run: show what would be cleaned"
    echo -e "  ${DIM}shipwright cleanup --force${RESET}       # Actually kill orphaned sessions"
    echo -e "  ${DIM}shipwright upgrade${RESET}               # Check what's changed since install"
    echo -e "  ${DIM}shipwright upgrade --apply${RESET}       # Apply available updates"
    echo ""
    echo -e "${DIM}Docs: https://sethdford.github.io/shipwright  |  GitHub: https://github.com/sethdford/shipwright${RESET}"
}

# ─── Command Router ──────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        session)
            check_tmux
            check_in_tmux
            exec "$SCRIPT_DIR/cct-session.sh" "$@"
            ;;
        status)
            check_tmux
            exec "$SCRIPT_DIR/cct-status.sh" "$@"
            ;;
        ps)
            check_tmux
            exec "$SCRIPT_DIR/cct-ps.sh" "$@"
            ;;
        logs)
            exec "$SCRIPT_DIR/cct-logs.sh" "$@"
            ;;
        templates)
            exec "$SCRIPT_DIR/cct-templates.sh" "$@"
            ;;
        doctor)
            exec "$SCRIPT_DIR/cct-doctor.sh" "$@"
            ;;
        cleanup)
            check_tmux
            exec "$SCRIPT_DIR/cct-cleanup.sh" "$@"
            ;;
        reaper)
            check_tmux
            exec "$SCRIPT_DIR/cct-reaper.sh" "$@"
            ;;
        upgrade)
            exec "$SCRIPT_DIR/cct-upgrade.sh" "$@"
            ;;
        loop)
            exec "$SCRIPT_DIR/cct-loop.sh" "$@"
            ;;
        pipeline)
            exec "$SCRIPT_DIR/cct-pipeline.sh" "$@"
            ;;
        worktree)
            exec "$SCRIPT_DIR/cct-worktree.sh" "$@"
            ;;
        prep)
            exec "$SCRIPT_DIR/cct-prep.sh" "$@"
            ;;
        daemon)
            exec "$SCRIPT_DIR/cct-daemon.sh" "$@"
            ;;
        memory)
            exec "$SCRIPT_DIR/cct-memory.sh" "$@"
            ;;
        cost)
            exec "$SCRIPT_DIR/cct-cost.sh" "$@"
            ;;
        fleet)
            exec "$SCRIPT_DIR/cct-fleet.sh" "$@"
            ;;
        fix)
            exec "$SCRIPT_DIR/cct-fix.sh" "$@"
            ;;
        init)
            exec "$SCRIPT_DIR/cct-init.sh" "$@"
            ;;
        setup)
            exec "$SCRIPT_DIR/cct-setup.sh" "$@"
            ;;
        dashboard|dash)
            exec "$SCRIPT_DIR/cct-dashboard.sh" "$@"
            ;;
        jira)
            exec "$SCRIPT_DIR/cct-jira.sh" "$@"
            ;;
        linear)
            exec "$SCRIPT_DIR/cct-linear.sh" "$@"
            ;;
        tracker)
            exec "$SCRIPT_DIR/cct-tracker.sh" "$@"
            ;;
        heartbeat)
            exec "$SCRIPT_DIR/cct-heartbeat.sh" "$@"
            ;;
        checkpoint)
            exec "$SCRIPT_DIR/cct-checkpoint.sh" "$@"
            ;;
        remote)
            exec "$SCRIPT_DIR/cct-remote.sh" "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            show_version
            ;;
        *)
            error "Unknown command: ${cmd}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
